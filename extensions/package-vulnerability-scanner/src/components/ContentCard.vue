<script setup lang="ts">
import { computed, defineProps } from "vue";
import ColorBadge from "./ui/ColorBadge.vue";
import { useScannerStore } from "../stores/scanner";
import type { Content } from "../stores/scanner";

const props = defineProps<{
  content: Content;
}>();

const scannerStore = useScannerStore();

const packageCount = computed(() => props.content.packages.length);
const isIncomplete = computed(() => props.content.bundle_id === null);

const hasVulnerabilities = computed(() => {
  return props.content.vulnerabilityCount > 0;
});

const vulnerabilityText = computed(() => {
  if (hasVulnerabilities.value) {
    const count = props.content.vulnerabilityCount;
    return count === 1 ? "1 vulnerability" : `${count} vulnerabilities`;
  }
  return "No vulnerabilities";
});

function handleClick() {
  scannerStore.currentContent = props.content;
  scrollTo({ top: 0, left: 0, behavior: "instant" });
}
</script>

<template>
  <button
    class="text-left min-w-0 border border-gray-300 hover:border-gray-400 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer bg-white group"
    @click="handleClick"
  >
    <div class="flex justify-between items-start mb-2 gap-4">
      <h3 class="font-medium text-blue-600 truncate group-hover:underline">
        {{ content.title || "Unnamed Content" }}
      </h3>

      <template v-if="!content.packageFetchError">
        <ColorBadge v-if="content.isLoadingPackages" type="neutral">
          Loading...
        </ColorBadge>

        <ColorBadge v-else :type="hasVulnerabilities ? 'error' : 'success'">
          {{ vulnerabilityText }}
        </ColorBadge>
      </template>
    </div>

    <div class="text-xs text-gray-600 truncate">
      Type: {{ content.app_mode || "Unknown type" }} Â· GUID: {{ content.guid }}
    </div>

    <div class="mt-1 text-xs text-gray-600 flex flex-wrap gap-x-3">
      <span v-if="content.py_version">Python: {{ content.py_version }}</span>
      <span v-if="content.r_version">R: {{ content.r_version }}</span>
      <span v-if="content.quarto_version"
        >Quarto: {{ content.quarto_version }}</span
      >
    </div>

    <div class="mt-2 text-sm">
      <span v-if="packageCount > 0" class="text-gray-600">
        {{ packageCount }} packages
      </span>
      <span v-else-if="isIncomplete" class="text-red-700">
        Incomplete content
      </span>
      <span v-else-if="content.packageFetchError" class="text-red-700">
        Error loading packages
      </span>
      <span v-else-if="content.isLoadingPackages" class="text-gray-600">
        Loading packages...
      </span>
      <span v-else class="text-gray-600"> No packages found </span>
    </div>
  </button>
</template>
