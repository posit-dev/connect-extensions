<script setup lang="ts">
import PackageHeader from "./PackageHeader.vue";
import VulnerabilityDetails from "./VulnerabilityDetails.vue";
import type { Vulnerability } from "../../stores/vulns";
import type { Package } from "../../stores/packages";

defineProps<{
  packageInfo: Package;
  vulnerabilities: Vulnerability[];
  repo: "pypi" | "cran";
  latestFixedVersion: string | null;
}>();
</script>

<template>
  <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-5 rounded-r-md">
    <PackageHeader
      :packageName="packageInfo.name"
      :packageVersion="packageInfo.version"
      :repo="repo"
    />

    <!-- Fix info at the top if available -->
    <div
      v-if="latestFixedVersion"
      class="bg-green-50 border-l-3 border-green-500 py-2 px-3 my-4 rounded-r-md"
    >
      <p class="m-0 text-[15px] text-green-700 flex items-center">
        <span class="mr-2">🛠️</span>
        <span
          >To fix
          {{
            vulnerabilities.length > 1
              ? "these vulnerabilities"
              : "this vulnerability"
          }}, upgrade to version {{ latestFixedVersion }} or later.</span
        >
      </p>
    </div>

    <!-- Vulnerabilities count if more than 1 -->
    <p
      v-if="vulnerabilities.length > 1"
      class="text-sm font-medium text-gray-700 mb-3"
    >
      {{ vulnerabilities.length }} vulnerabilities found for this package:
    </p>

    <!-- List of vulnerabilities -->
    <div
      v-for="(vulnerability, index) in vulnerabilities"
      :key="vulnerability.id"
      class="mb-4 last:mb-0 pt-4 first:pt-0"
      :class="{ 'border-t border-gray-200': index > 0 }"
    >
      <VulnerabilityDetails
        :id="vulnerability.id"
        :summary="vulnerability.summary"
        :details="vulnerability.details"
        :publishDate="vulnerability.published"
        :modifiedDate="vulnerability.modified"
      />
    </div>
  </div>
</template>
