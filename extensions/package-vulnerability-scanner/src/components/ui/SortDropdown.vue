<script setup lang="ts">
import { computed, ref, onMounted, onBeforeUnmount, useTemplateRef } from "vue";

import ChevronDown from "../icons/ChevronDown.vue";
import CheckMark from "../icons/CheckMark.vue";
import AscendingSort from "../icons/AscendingSort.vue";
import DescendingSort from "../icons/DescendingSort.vue";

export interface SortOrderOption {
  id: string;
  label: string;
  sortOrder: "asc" | "desc";
}

export interface SortOption {
  id: string;
  label: string;
  sortOrderDefault: "asc" | "desc";
  sortOrderOptions: SortOrderOption[];
}

export interface SortSelection {
  id: string;
  label: string;
  sortOrder: "asc" | "desc";
}

const props = defineProps<{
  sortOptions: SortOption[];
}>();

const activeOption = defineModel<SortSelection>({
  required: true,
});

const activeOrderOptions = computed<SortOrderOption[]>(() => {
  const option = props.sortOptions.find(
    (opt) => opt.id === activeOption.value.id,
  );
  return option ? option.sortOrderOptions : [];
});

const isOpen = ref(false);
const optionFocusIndex = ref();

const dropdownButton = useTemplateRef<HTMLButtonElement>("dropdownButton");
const dropdownMenu = useTemplateRef<HTMLDivElement>("dropdownMenu");
const dropdownOptions = useTemplateRef<HTMLButtonElement[]>("options");

function selectOption(option: SortOption) {
  activeOption.value = {
    id: option.id,
    label: option.label,
    sortOrder: option.sortOrderDefault,
  };
  closeMenu();
}

function selectOrderOption(option: SortOrderOption) {
  activeOption.value.sortOrder = option.sortOrder;
  closeMenu();
}

function closeMenu() {
  isOpen.value = false;
  dropdownButton.value?.focus();
}

function focusOptionIndex(index: number) {
  if (dropdownOptions.value === null) return;

  optionFocusIndex.value = index;
  dropdownOptions.value[index]?.focus();
}

function focusNextOption() {
  if (dropdownOptions.value === null) return;

  const nextIndex =
    optionFocusIndex.value + 1 >= dropdownOptions.value.length
      ? 0
      : optionFocusIndex.value + 1;
  focusOptionIndex(nextIndex);
}

function focusPrevOption() {
  if (dropdownOptions.value === null) return;

  const prevIndex =
    optionFocusIndex.value <= 0
      ? dropdownOptions.value.length - 1
      : optionFocusIndex.value - 1;
  focusOptionIndex(prevIndex);
}

function handleOutsideClick(event: MouseEvent) {
  if (
    isOpen.value &&
    !dropdownButton.value?.contains(event.target as Node) &&
    !dropdownMenu.value?.contains(event.target as Node)
  ) {
    closeMenu();
  }
}

onMounted(() => {
  document.addEventListener("mousedown", handleOutsideClick);
});

onBeforeUnmount(() => {
  document.removeEventListener("mousedown", handleOutsideClick);
});
</script>

<template>
  <div class="relative inline-block">
    <div>
      <button
        ref="dropdownButton"
        type="button"
        class="group cursor-pointer inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-medium text-gray-600 ring-1 ring-gray-300 ring-inset hover:ring-gray-500 hover:text-gray-800 hover:bg-gray-50"
        id="menu-button"
        :aria-expanded="isOpen"
        aria-haspopup="true"
        @click="isOpen = !isOpen"
        @keydown.escape="closeMenu"
        @keydown.arrow-down.prevent="focusOptionIndex(0)"
      >
        <DescendingSort
          v-if="activeOption.sortOrder === 'desc'"
          class="text-gray-600 group-hover:text-gray-800"
        />
        <AscendingSort
          v-if="activeOption.sortOrder === 'asc'"
          class="text-gray-600 group-hover:text-gray-800"
        />

        {{ activeOption.label }}

        <ChevronDown
          aria-hidden="true"
          class="text-gray-600 group-hover:text-gray-800"
        />
      </button>
    </div>

    <div
      v-if="isOpen"
      ref="dropdownMenu"
      class="absolute right-0 divide-y divide-gray-100 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-hidden"
      role="menu"
      aria-orientation="vertical"
      aria-labelledby="menu-button"
      tabindex="-1"
      @keydown.tab.prevent="closeMenu"
      @keydown.escape="closeMenu"
      @keydown.arrow-up.prevent="focusPrevOption"
      @keydown.arrow-down.prevent="focusNextOption"
      @keydown.home.prevent="focusOptionIndex(0)"
      @keydown.end.prevent="focusOptionIndex(sortOptions.length - 1)"
    >
      <div class="py-1" role="none">
        <div role="presentation" aria-hidden="true">
          <span class="text-xs font-medium px-2 py-2 text-gray-600">
            Sort by
          </span>
        </div>

        <button
          v-for="option in sortOptions"
          ref="options"
          :key="option.id"
          :id="option.id"
          class="flex items-center w-full text-left cursor-pointer px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100"
          type="button"
          role="menuitem"
          tabindex="-1"
          @click="selectOption(option)"
        >
          <CheckMark
            v-if="activeOption.id === option.id"
            class="text-gray-800"
          />

          <span class="ml-3 first:ml-7">{{ option.label }}</span>
        </button>
      </div>

      <div class="py-1" role="none">
        <div role="presentation" aria-hidden="true">
          <span class="text-xs font-medium px-2 py-2 text-gray-600">
            Order
          </span>
        </div>

        <button
          v-for="subOption in activeOrderOptions"
          ref="options"
          :key="subOption.id"
          :id="subOption.id"
          class="flex items-center w-full text-left cursor-pointer px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100"
          type="button"
          role="menuitem"
          tabindex="-1"
          @click="selectOrderOption(subOption)"
        >
          <CheckMark
            v-if="activeOption.sortOrder === subOption.sortOrder"
            class="text-gray-800"
          />

          <span class="ml-3 first:ml-7">{{ subOption.label }}</span>
        </button>
      </div>
    </div>
  </div>
</template>
