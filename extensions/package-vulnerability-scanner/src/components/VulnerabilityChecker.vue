<script setup lang="ts">
import {
  useScannerStore,
  type Content,
  type DetailedPackage,
} from "../stores/scanner";
import { computed, ref } from "vue";

// Import UI components
import LoadingSpinner from "./ui/LoadingSpinner.vue";
import StatusMessage from "./ui/StatusMessage.vue";

// Import vulnerability components
import StatsPanel, { type FilterType } from "./vulnerability/StatsPanel.vue";
import EmptyState from "./vulnerability/EmptyState.vue";
import PackageList from "./vulnerability/PackageList.vue";
import ArrowTopRight from "./icons/ArrowTopRight.vue";

const props = defineProps<{
  content: Content;
}>();

const scannerStore = useScannerStore();

const hasPackages = computed(() => {
  return props.content.packages.length > 0;
});

// Go back to content list
function goBack() {
  scannerStore.currentContent = undefined;
  scrollTo({ top: 0, left: 0, behavior: "instant" });
}

const vulnerablePackages = computed((): DetailedPackage[] => {
  return props.content.packages.filter((pkg) => {
    return pkg.vulnerabilities && pkg.vulnerabilities.length > 0;
  });
});

const pythonPackages = computed((): DetailedPackage[] => {
  const packages = props.content.packages;

  return packages.filter((p) => {
    return p.language.toLowerCase() === "python";
  });
});

const rPackages = computed((): DetailedPackage[] => {
  const packages = props.content.packages;

  return packages.filter((p) => {
    return p.language.toLowerCase() === "r";
  });
});

// Total number of vulnerabilities (CVEs) across all packages
const totalVulnerabilities = computed(() => {
  return vulnerablePackages.value.reduce((total, pkg) => {
    return total + (pkg.vulnerabilities ? pkg.vulnerabilities.length : 0);
  }, 0);
});

const activeFilter = ref<FilterType>("vulnerable");

const filterTitle = computed(() => {
  switch (activeFilter.value) {
    case "all":
      return "All Packages";
    case "python":
      return "Python Packages";
    case "r":
      return "R Packages";
    case "vulnerable":
      return "Vulnerable Packages";
    default:
      return "Packages";
  }
});

// Use the filtered arrays for the displayed packages
const filteredPackages = computed((): DetailedPackage[] => {
  switch (activeFilter.value) {
    case "python":
      return pythonPackages.value;
    case "r":
      return rPackages.value;
    case "vulnerable":
      return vulnerablePackages.value;
    default:
      return props.content.packages;
  }
});

const isIncomplete = computed(() => {
  return props.content.bundle_id === null;
});

const hasLanguageVersion = computed(() => {
  return (
    props.content.py_version ||
    props.content.r_version ||
    props.content.quarto_version
  );
});
</script>

<template>
  <button
    @click="goBack"
    class="px-4 py-2 mb-4 bg-white shrink-0 cursor-pointer hover:bg-gray-200 text-gray-800 rounded-md shadow-sm hover:shadow-md transition-colors"
  >
    ‚Üê Back to Content List
  </button>

  <div class="max-w-4xl mx-auto p-5 bg-white rounded-lg shadow-md">
    <!-- Content header with title and back button -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-xl text-gray-800 font-semibold">{{ content.title }}</h2>
        <div class="flex flex-wrap space-x-2 mb-1">
          <p class="text-sm text-gray-600">
            {{ content.guid }}
          </p>
          <a
            v-if="content.dashboard_url"
            :href="content.dashboard_url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-blue-600 hover:text-blue-800 flex items-center"
          >
            <span>View on Connect</span>
            <ArrowTopRight class="ml-1" />
          </a>
        </div>

        <div
          v-if="hasLanguageVersion"
          class="flex flex-wrap gap-x-4 text-sm text-gray-600"
        >
          <span v-if="content.py_version">
            Python: {{ content.py_version }}
          </span>
          <span v-if="content.r_version">R: {{ content.r_version }}</span>
          <span v-if="content.quarto_version">
            Quarto: {{ content.quarto_version }}
          </span>
        </div>

        <p v-if="content.last_deployed_time" class="text-sm text-gray-600">
          Last Deployed:
          {{ new Date(content.last_deployed_time).toLocaleString() }}
        </p>
      </div>
    </div>

    <!-- Loading state -->
    <LoadingSpinner
      v-if="content.isLoadingPackages"
      message="Loading package data..."
      size="md"
    />

    <StatusMessage
      v-if="isIncomplete"
      type="error"
      message="This has not been fully deployed. Try publishing again."
    />

    <StatusMessage
      v-else-if="content.packageFetchError"
      type="error"
      message="Error analyzing packages. The content may not be fully deployed."
    />

    <!-- Content loaded successfully -->
    <template v-else>
      <StatsPanel
        v-model="activeFilter"
        :totalPackages="content.packages.length"
        :pythonPackages="pythonPackages.length"
        :rPackages="rPackages.length"
        :vulnerabilities="totalVulnerabilities"
      />

      <h3 class="text-lg text-gray-800 mb-4">{{ filterTitle }}</h3>

      <EmptyState v-if="!hasPackages">
        <p>This content has no packages. No vulnerabilities found.</p>
      </EmptyState>

      <EmptyState v-else-if="filteredPackages.length === 0">
        <p v-if="activeFilter === 'vulnerable'">No vulnerabilities found.</p>
        <p v-else-if="activeFilter === 'python'">No Python packages found.</p>
        <p v-else-if="activeFilter === 'r'">No R packages found.</p>
        <p v-else>No packages found.</p>
      </EmptyState>

      <PackageList v-else :packages="filteredPackages" />
    </template>
  </div>
</template>
