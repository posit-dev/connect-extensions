import { defineStore } from "pinia";
import { ref } from "vue";

export interface ContentListItem {
  guid: string;
  title: string;
  app_mode?: string;
  content_url?: string;
  dashboard_url?: string;
  name?: string;
  description?: string;
  last_deployed_time?: string;
  py_version?: string;
  r_version?: string;
  quarto_version?: string;
  bundle_id?: string | null;
}

export const useContentStore = defineStore("content", () => {
  const contentList = ref<ContentListItem[]>([]);
  const isLoading = ref(false);
  const error = ref<Error | null>(null);
  const showAllContent = ref(false);

  // Track if content has been loaded for the current mode
  const isContentLoaded = ref(false);

  // Fetch all available content items
  async function fetchContentList(forceRefresh: boolean = false) {
    // Skip if content is already loaded for this mode (unless forcing refresh)
    if (!forceRefresh && isContentLoaded.value && contentList.value.length > 0) return;

    isLoading.value = true;
    error.value = null;

    try {
      const url = showAllContent.value ? "api/content?show_all=true" : "api/content";
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const data = await response.json();
      contentList.value = data;
      isContentLoaded.value = true;
    } catch (err) {
      console.error("Error fetching content list:", err);
      error.value = err as Error;
      throw err;
    } finally {
      isLoading.value = false;
    }
  }

  return {
    // State
    contentList,
    isLoading,
    error,
    isContentLoaded,
    showAllContent,

    // Actions
    fetchContentList,
  };
});
