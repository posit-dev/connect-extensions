name: Connect Integration Tests

on:
  workflow_call:
    inputs:
      extensions:
        description: "JSON array of extension names to test"
        required: true
        type: string
    outputs:
      success_matrix:
        description: "Extensions that passed all tests"
        value: ${{ jobs.collect-results.outputs.matrix }}
    secrets:
      CONNECT_LICENSE:
        required: true

jobs:
  setup-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      versions: ${{ steps.versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4
      - id: versions
        working-directory: ./integration
        # The `jq` command is "output compact, raw input, slurp, split on new lines, and remove the last element". This results in a JSON array of Connect versions (e.g., ["2025.01.0", "2024.12.0"]).
        run: |
          versions=$(make print-versions | jq -c -Rs 'split("\n") | .[:-1]')

          # Show processed versions
          echo "Versions: $versions"

          # Set output for next jobs
          echo "versions=$versions" >> "$GITHUB_OUTPUT"

  connect-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Max time to run the integration tests
    needs: setup-integration-test
    strategy:
      fail-fast: false
      matrix:
        extension: ${{ fromJson(inputs.extensions) }}
        connect_version: ${{ fromJson(needs.setup-integration-test.outputs.versions) }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/connect-integration-test
        id: test
        with:
          extension-name: ${{ matrix.extension }}
          connect-version: ${{ matrix.connect_version }}
          connect-license: ${{ secrets.CONNECT_LICENSE }}

      - uses: actions/upload-artifact@v4
        if: |
          always() && 
          steps.test.outcome != 'cancelled' && 
          steps.test.outcome != 'skipped'
        with:
          name: ${{ matrix.extension }}-${{ matrix.connect_version }}-test-report
          path: ${{ steps.test.outputs.reports_path }}/*.xml
          retention-days: 7

  # Analyses the test result files and publishes the results on the GitHub Actions job summary page
  integration-test-report:
    needs: connect-integration-test
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions:
      checks: write
      pull-requests: write
    # Only run if tests weren't skipped or cancelled
    if: |
      always() && 
      !contains(needs.connect-integration-test.result, 'skipped') &&
      !contains(needs.connect-integration-test.result, 'cancelled')
    steps:
      - uses: actions/download-artifact@v4
        id: download
        with:
          path: artifacts
          pattern: "*Integration Test Report"

      - uses: EnricoMi/publish-unit-test-result-action@v2
        if: ${{ steps.download.outputs.download-path != '' }}
        with:
          check_name: integration-test-results
          comment_mode: off
          files: "artifacts/**/*.xml"
          report_individual_runs: true

  # Provides a matrix of extensions that passed all of the Connect integration tests
  collect-results:
    needs: [connect-integration-test, setup-integration-test]
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      matrix: ${{ steps.collect.outputs.success_matrix }}
    # Only run if tests actually executed
    if: |
      !contains(needs.connect-integration-test.result, 'skipped') &&
      !contains(needs.connect-integration-test.result, 'cancelled') &&
      needs.connect-integration-test.result != ''
    steps:
      - id: collect
        run: |
          # Validate inputs first
          all_versions='${{ needs.setup-integration-test.outputs.versions }}'
          extensions='${{ inputs.extensions }}'
          
          if [[ -z "$all_versions" || -z "$extensions" ]]; then
            echo "❌ Missing required inputs"
            exit 1
          fi
          
          # Get matrix results and validate
          matrix_results='${{ toJSON(needs.connect-integration-test.result) }}'
          if [[ -z "$matrix_results" || "$matrix_results" == "{}" ]]; then
            echo "❌ No matrix results found"
            echo "success_matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "🔍 Processing matrix results"
          echo "Versions to check: $all_versions"
          echo "Extensions to check: $extensions"
          
          # Track extensions that passed ALL version tests
          success_list=()
          
          # Process each extension
          for ext in $(echo "$extensions" | jq -r '.[]'); do
            all_passed=true
            echo "📦 Checking extension: $ext"
            
            # Must pass ALL versions to be included
            for version in $(echo "$all_versions" | jq -r '.[]'); do
              echo "🔎 Checking version: $version"
              
              # Find specific matrix job result
              result=$(echo "$matrix_results" | jq -r \
                --arg ext "$ext" \
                --arg ver "$version" \
                '.jobs[] | 
                select(.matrix.extension == $ext and .matrix.connect_version == $ver) | 
                .result')
              
              echo "Result for $ext @ $version: $result"
              
              if [[ "$result" != "success" ]]; then
                all_passed=false
                echo "❌ Failed: $ext @ $version"
              else
                echo "✅ Passed: $ext @ $version"
              fi
            done
            
            # Only add to success list if ALL versions passed
            if [[ "$all_passed" == "true" ]]; then
              success_list+=("$ext")
              echo "🎉 SUCCESS: $ext passed all version tests"
            else
              echo "⚠️ FAILED: $ext failed one or more version tests"
            fi
          done
          
          # Create JSON array output
          success_matrix=$(jq -n --arg arr "$(IFS=,; echo "${success_list[*]}")" \
            '$arr | split(",")' -c)
          
          # Validate and set output
          if [[ -z "$success_matrix" ]]; then
            echo "⚠️ No extensions passed all tests"
            echo "success_matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "📊 Final success matrix: $success_matrix"
            echo "success_matrix=$success_matrix" >> $GITHUB_OUTPUT
          fi
